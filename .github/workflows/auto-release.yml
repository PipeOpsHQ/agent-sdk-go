name: Auto Release

on:
  push:
    branches: [main, master]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  auto-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.1'
          cache: true

      - name: Test
        run: go test ./...

      - name: Compute next version
        id: version
        shell: bash
        run: |
          set -euo pipefail

          LATEST_TAG=$(git tag --list 'v*' --sort=-v:refname | head -n 1)
          if [ -z "$LATEST_TAG" ]; then
            LATEST_TAG="v0.0.0"
          fi

          RANGE="${LATEST_TAG}..HEAD"
          COMMIT_COUNT=$(git rev-list --count "$RANGE" 2>/dev/null || echo 0)
          if [ "$COMMIT_COUNT" -eq 0 ]; then
            echo "should_release=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          LOG=$(git log "$RANGE" --pretty=format:'%s%n%b')
          BUMP="patch"
          if echo "$LOG" | grep -qiE 'BREAKING CHANGE|!:'; then
            BUMP="major"
          elif echo "$LOG" | grep -qiE '^feat(\(|:)|^feature(\(|:)'; then
            BUMP="minor"
          fi

          VERSION="${LATEST_TAG#v}"
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"
          PATCH="${PATCH%%-*}"

          case "$BUMP" in
            major) NEXT="v$((MAJOR + 1)).0.0" ;;
            minor) NEXT="v${MAJOR}.$((MINOR + 1)).0" ;;
            patch) NEXT="v${MAJOR}.${MINOR}.$((PATCH + 1))" ;;
          esac

          if git rev-parse -q --verify "refs/tags/${NEXT}" >/dev/null; then
            echo "should_release=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "latest_tag=${LATEST_TAG}" >> "$GITHUB_OUTPUT"
          echo "next_tag=${NEXT}" >> "$GITHUB_OUTPUT"
          echo "should_release=true" >> "$GITHUB_OUTPUT"

      - name: Create tag
        if: steps.version.outputs.should_release == 'true'
        run: |
          TAG="${{ steps.version.outputs.next_tag }}"
          git tag "$TAG"
          git push origin "$TAG"

      - name: Create release
        if: steps.version.outputs.should_release == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.next_tag }}
          generate_release_notes: true
          make_latest: true
