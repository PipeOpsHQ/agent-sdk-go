name: Auto Release

on:
  push:
    branches: [main, master]
    paths:
      - 'framework/agent/**'
      - 'framework/graph/**'
      - 'framework/graphs/**'
      - 'framework/llm/**'
      - 'framework/providers/**'
      - 'framework/tools/**'
      - 'framework/types/**'
      - 'framework/workflow/**'
      - 'framework/state/**'
      - 'framework/runtime/**'
      - 'framework/runtimeconfig/**'
      - 'framework/devui/**'
      - 'framework/observe/**'
      - 'framework/integrations/**'
      - 'framework/adapters/**'
      - 'cmd/**'
      - 'go.mod'
      - 'go.sum'

permissions:
  contents: write
  pull-requests: write

jobs:
  analyze:
    name: Analyze Changes
    runs-on: ubuntu-latest
    outputs:
      should_release: ${{ steps.analyze.outputs.should_release }}
      bump_type: ${{ steps.analyze.outputs.bump_type }}
      next_version: ${{ steps.analyze.outputs.next_version }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get latest tag
        id: latest_tag
        run: |
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "tag=${LATEST_TAG}" >> $GITHUB_OUTPUT

      - name: Analyze commits
        id: analyze
        run: |
          LATEST_TAG="${{ steps.latest_tag.outputs.tag }}"
          COMMITS=$(git log ${LATEST_TAG}..HEAD --oneline 2>/dev/null || git log --oneline | head -20)
          
          if [ -z "$COMMITS" ]; then
            echo "should_release=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          BUMP_TYPE="patch"
          if echo "$COMMITS" | grep -qiE "BREAKING CHANGE"; then
            BUMP_TYPE="major"
          elif echo "$COMMITS" | grep -qiE "^[a-f0-9]+\s+feat"; then
            BUMP_TYPE="minor"
          fi
          
          CURRENT="${LATEST_TAG#v}"
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"
          PATCH="${PATCH%%-*}"
          
          case "$BUMP_TYPE" in
            major) NEXT="v$((MAJOR + 1)).0.0" ;;
            minor) NEXT="v${MAJOR}.$((MINOR + 1)).0" ;;
            patch) NEXT="v${MAJOR}.${MINOR}.$((PATCH + 1))" ;;
          esac
          
          echo "should_release=true" >> $GITHUB_OUTPUT
          echo "bump_type=${BUMP_TYPE}" >> $GITHUB_OUTPUT
          echo "next_version=${NEXT}" >> $GITHUB_OUTPUT

  draft-release:
    name: Draft Release
    runs-on: ubuntu-latest
    needs: analyze
    if: needs.analyze.outputs.should_release == 'true'

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: release-drafter/release-drafter@v5
        with:
          config-name: release-drafter.yml
          version: ${{ needs.analyze.outputs.next_version }}
          tag: ${{ needs.analyze.outputs.next_version }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  auto-tag:
    name: Auto Tag Release
    runs-on: ubuntu-latest
    needs: analyze
    if: |
      needs.analyze.outputs.should_release == 'true' && 
      contains(github.event.head_commit.message, '[release]')

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache: true

      - name: Run tests
        run: go test -v ./...

      - name: Create tag
        run: |
          VERSION="${{ needs.analyze.outputs.next_version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "${VERSION}" -m "Release ${VERSION}"
          git push origin "${VERSION}"
