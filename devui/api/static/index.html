<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>PipeOps Agentic Console</title>
    <link rel="stylesheet" href="/styles.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
  </head>
  <body>
    <div class="app-container">
      <!-- Sidebar -->
      <aside class="sidebar">
        <div class="sidebar-header">
          <div class="logo">
            <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
              <rect width="32" height="32" rx="8" fill="url(#logo-gradient)"/>
              <path d="M16 8L22 12V20L16 24L10 20V12L16 8Z" stroke="white" stroke-width="2" fill="none"/>
              <circle cx="16" cy="16" r="3" fill="white"/>
              <defs>
                <linearGradient id="logo-gradient" x1="0" y1="0" x2="32" y2="32">
                  <stop offset="0%" stop-color="#6366f1"/>
                  <stop offset="100%" stop-color="#8b5cf6"/>
                </linearGradient>
              </defs>
            </svg>
            <span class="logo-text">PipeOps</span>
          </div>
        </div>

        <nav class="sidebar-nav">
          <button class="nav-item active" data-tab="live" title="Live">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="8"/>
              <circle cx="12" cy="12" r="3"/>
            </svg>
            <span>Live</span>
          </button>
          <button class="nav-item" data-tab="runs" title="Runs">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M5 12h14M12 5l7 7-7 7"/>
            </svg>
            <span>Runs</span>
          </button>
          <button class="nav-item" data-tab="playground" title="Playground">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polygon points="5,3 19,12 5,21"/>
            </svg>
            <span>Playground</span>
          </button>
          <button class="nav-item" data-tab="actions" title="Actions">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
            </svg>
            <span>Actions</span>
          </button>
          <button class="nav-item" data-tab="prompts" title="Prompts">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
              <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
            </svg>
            <span>Prompts</span>
          </button>
          <button class="nav-item" data-tab="workflows" title="Graphs">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="5" cy="12" r="2"/>
              <circle cx="12" cy="6" r="2"/>
              <circle cx="12" cy="18" r="2"/>
              <circle cx="19" cy="12" r="2"/>
              <path d="M7 12h3M14 6h2.5a1 1 0 011 1v4M14 18h2.5a1 1 0 001-1v-4"/>
            </svg>
            <span>Graphs</span>
          </button>
          <button class="nav-item" data-tab="tools" title="Tools">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14.7 6.3a1 1 0 000 1.4l1.6 1.6a1 1 0 001.4 0l3.77-3.77a6 6 0 01-7.94 7.94l-6.91 6.91a2.12 2.12 0 01-3-3l6.91-6.91a6 6 0 017.94-7.94l-3.76 3.76z"/>
            </svg>
            <span>Tools</span>
          </button>
          <button class="nav-item" data-tab="runtime" title="Runtime">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="2" y="3" width="20" height="14" rx="2"/>
              <path d="M8 21h8M12 17v4"/>
            </svg>
            <span>Runtime</span>
          </button>
          <button class="nav-item" data-tab="audit" title="Audit">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 11l3 3L22 4"/>
              <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
            </svg>
            <span>Audit</span>
          </button>
          <button class="nav-item" data-tab="skills" title="Skills">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/>
              <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>
            </svg>
            <span>Skills</span>
          </button>
          <button class="nav-item" data-tab="scheduler" title="Scheduler">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <polyline points="12 6 12 12 16 14"/>
            </svg>
            <span>Scheduler</span>
          </button>
        </nav>

        <div class="sidebar-footer">
          <button class="nav-item" data-tab="settings" title="Settings">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="3"/>
              <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
            </svg>
            <span>Settings</span>
          </button>
          <div class="theme-toggle">
            <button id="themeToggle" title="Toggle theme">
              <svg class="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="5"/>
                <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
              </svg>
              <svg class="icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/>
              </svg>
            </button>
          </div>
        </div>
      </aside>

      <!-- Main Content -->
      <main class="main-content">
        <div class="command-bar">
          <div class="command-prefix">⌘K</div>
          <input id="commandInput" class="command-input" placeholder='Ask control plane: "resume failed runs from last checkpoint"' />
          <button id="commandRun" class="command-run">Execute</button>
          <span id="rbacRoleBadge" class="badge" style="margin-left:8px;">role: unknown</span>
        </div>
        <div class="command-result" id="commandResult"></div>

        <!-- Live Tab -->
        <section id="tab-live" class="tab active">
          <div class="page-header">
            <h1>Live Agent View</h1>
            <p class="page-subtitle">Observe cognition, execution, and intervention in real time.</p>
          </div>

          <div class="live-runs-strip" id="liveRunsStrip">
            <div class="empty-state">
              <p>No active entities</p>
            </div>
          </div>

          <div class="metrics-grid">
            <div class="metric-card">
              <div class="metric-icon success">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M22 11.08V12a10 10 0 11-5.93-9.14"/>
                  <polyline points="22,4 12,14.01 9,11.01"/>
                </svg>
              </div>
              <div class="metric-content">
                <span class="metric-value" id="metric-completed">-</span>
                <span class="metric-label">Completed Runs</span>
              </div>
            </div>
            <div class="metric-card">
              <div class="metric-icon warning">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"/>
                  <path d="M12 6v6l4 2"/>
                </svg>
              </div>
              <div class="metric-content">
                <span class="metric-value" id="metric-running">-</span>
                <span class="metric-label">Running</span>
              </div>
            </div>
            <div class="metric-card">
              <div class="metric-icon error">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"/>
                  <path d="M15 9l-6 6M9 9l6 6"/>
                </svg>
              </div>
              <div class="metric-content">
                <span class="metric-value" id="metric-failed">-</span>
                <span class="metric-label">Failed</span>
              </div>
            </div>
            <div class="metric-card">
              <div class="metric-icon info">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                  <path d="M2 17l10 5 10-5M2 12l10 5 10-5"/>
                </svg>
              </div>
              <div class="metric-content">
                <span class="metric-value" id="metric-tools">-</span>
                <span class="metric-label">Active Tools</span>
              </div>
            </div>
          </div>

          <div class="dashboard-grid">
            <div class="card">
              <div class="card-header">
                <h3>Recent Activity</h3>
                <span class="badge live">
                  <span class="live-dot"></span>
                  Live
                </span>
              </div>
              <div class="activity-list" id="activityList">
                <div class="empty-state">
                  <p>No recent activity</p>
                </div>
              </div>
            </div>

            <div class="card">
              <div class="card-header">
                <h3>Control Plane State</h3>
              </div>
              <div class="status-grid">
                <div class="status-item">
                  <span class="status-indicator online"></span>
                  <span class="status-name">LLM Provider</span>
                  <span class="status-value" id="status-provider">-</span>
                </div>
                <div class="status-item">
                  <span class="status-indicator" id="status-queue-dot"></span>
                  <span class="status-name">Queue</span>
                  <span class="status-value" id="status-queue">-</span>
                </div>
                <div class="status-item">
                  <span class="status-indicator" id="status-workers-dot"></span>
                  <span class="status-name">Workers</span>
                  <span class="status-value" id="status-workers">-</span>
                </div>
                <div class="status-item">
                  <span class="status-indicator online"></span>
                  <span class="status-name">State Store</span>
                  <span class="status-value">Connected</span>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Runs Tab -->
        <section id="tab-runs" class="tab">
          <div class="page-header">
            <h1>Runs</h1>
            <div class="header-actions">
              <button class="btn btn-secondary" id="refreshRuns">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                  <path d="M23 4v6h-6M1 20v-6h6"/>
                  <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
                </svg>
                Refresh
              </button>
            </div>
          </div>

          <div class="runs-container">
            <div class="runs-list-panel">
              <div class="search-box">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                  <circle cx="11" cy="11" r="8"/>
                  <path d="M21 21l-4.35-4.35"/>
                </svg>
                <input type="text" id="searchRuns" placeholder="Search runs...">
              </div>
              <div class="runs-list" id="runsList">
                <div class="empty-state">
                  <p>No runs found</p>
                </div>
              </div>
            </div>

            <div class="run-detail-panel">
              <div class="run-detail-header" id="runDetailHeader">
                <h2>Select a run</h2>
                <p>Click on a run to view details</p>
              </div>
              <div class="run-tabs">
                <button class="run-tab active" data-run-tab="overview">Overview</button>
                <button class="run-tab" data-run-tab="trace">Trace</button>
                <button class="run-tab" data-run-tab="timeline">Timeline</button>
                <button class="run-tab" data-run-tab="messages">Messages</button>
                <button class="run-tab" data-run-tab="tools">Tool Calls</button>
              </div>
              <div class="run-tab-content" id="runTabContent">
                <div id="run-overview" class="run-panel active">
                  <div class="run-overview-grid">
                    <pre id="runDetail" class="code-block"></pre>
                    <div class="run-ops-column">
                      <div class="card">
                        <div class="card-header">
                          <h3>Execution State</h3>
                        </div>
                        <div class="run-exec-state" id="runExecutionState">
                          <div class="empty-state"><p>Select a run to view execution state.</p></div>
                        </div>
                      </div>
                      <div class="card">
                        <div class="card-header">
                          <h3>Interventions</h3>
                        </div>
                        <div class="run-interventions">
                          <div class="intervention-actions">
                            <button class="btn btn-secondary btn-sm" data-intervention="cancel" data-requires-role="operator">Cancel</button>
                            <button class="btn btn-secondary btn-sm" data-intervention="force_retry" data-requires-role="operator">Force Retry</button>
                            <button class="btn btn-secondary btn-sm" data-intervention="skip_node" data-requires-role="operator">Skip Node</button>
                            <button class="btn btn-secondary btn-sm" data-intervention="override_router" data-requires-role="operator">Override Route</button>
                            <button class="btn btn-secondary btn-sm" data-intervention="inject_tool_result" data-requires-role="operator">Inject Tool Result</button>
                          </div>
                          <div class="intervention-log" id="interventionLog">
                            <div class="empty-state"><p>No interventions recorded.</p></div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div id="run-trace" class="run-panel">
                  <div class="trace-tree" id="runTraceTree">
                    <div class="empty-state"><p>Select a run to view its execution trace.</p></div>
                  </div>
                </div>
                <div id="run-timeline" class="run-panel">
                  <div class="cognitive-metrics" id="runCognitiveMetrics"></div>
                  <div class="attempt-lane" id="runAttemptLane"></div>
                  <div class="timeline cognitive" id="runTimeline"></div>
                </div>
                <div id="run-messages" class="run-panel">
                  <div class="messages-list" id="runMessages"></div>
                </div>
                <div id="run-tools" class="run-panel">
                  <div class="tool-calls-list" id="runToolCalls"></div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Playground Tab -->
        <section id="tab-playground" class="tab">
          <div class="page-header">
            <h1>Playground</h1>
            <div style="display:flex;align-items:center;gap:12px;">
              <p class="page-subtitle" style="margin:0;">Select an agent flow and test it interactively</p>
              <button class="btn btn-ghost btn-sm" id="toggleHistoryBtn" onclick="togglePlaygroundHistory()" title="Toggle history panel">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                  <path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                History
              </button>
            </div>
          </div>

          <!-- Flow Picker Bar -->
          <div class="playground-flow-bar">
            <div class="flow-picker">
              <label>Playbook</label>
              <select id="playgroundFlow" class="select">
                <option value="">(none - use quick setup below)</option>
              </select>
              <div style="display:flex;gap:8px;margin-top:8px;">
                <button type="button" class="btn btn-ghost btn-sm" id="supportModeBtn">Support Mode</button>
                <button type="button" class="btn btn-ghost btn-sm" id="resetModeBtn">Reset</button>
              </div>
            </div>
            <div class="flow-info" id="playgroundFlowInfo" style="display:none;">
              <div class="flow-desc" id="playgroundFlowDesc"></div>
              <div class="flow-meta" id="playgroundFlowMeta"></div>
            </div>
          </div>

          <div class="playground-container">
            <div class="playground-config">
              <details class="config-details" id="playgroundConfigDetails">
                <summary>Setup (optional) <span class="config-badge" id="configBadge">manual</span></summary>
                <div class="config-group">
                  <label>Execution Pattern</label>
                  <select id="playgroundWorkflow" class="select">
                    <option value="basic">basic - one pass</option>
                    <option value="chain">chain - think, plan, execute, summarize</option>
                    <option value="router">router - pick specialist path</option>
                    <option value="map-reduce">map-reduce - split, process, combine</option>
                  </select>
                </div>
                <div class="config-group">
                  <label>Tool Access</label>
                  <select id="playgroundTools" class="select" multiple size="6">
                  </select>
                  <small style="color:var(--text-muted);font-size:11px;">Tip: keep this minimal. Hold Ctrl/Cmd for multi-select.</small>
                </div>
                <div class="config-group">
                  <label>Skill Packs</label>
                  <div style="display:flex;gap:6px;margin:-2px 0 8px;">
                    <button type="button" class="btn btn-ghost btn-sm" id="selectAllSkills">Select all</button>
                    <button type="button" class="btn btn-ghost btn-sm" id="clearAllSkills">Clear</button>
                  </div>
                  <select id="playgroundSkills" class="select" multiple size="4">
                  </select>
                  <small style="color:var(--text-muted);font-size:11px;">Adds domain behavior (research, docs, security, etc.).</small>
                </div>
                <div class="config-group">
                  <label>Safety Checks</label>
                  <div style="display:flex;gap:6px;margin:-2px 0 8px;">
                    <button type="button" class="btn btn-ghost btn-sm" id="selectAllGuardrails">Select all</button>
                    <button type="button" class="btn btn-ghost btn-sm" id="clearAllGuardrails">Clear</button>
                  </div>
                  <select id="playgroundGuardrails" class="select" multiple size="4">
                  </select>
                  <small style="color:var(--text-muted);font-size:11px;">Optional validation for input/output safety.</small>
                </div>
                <div class="config-group">
                  <label>Prompt Template (optional)</label>
                  <select id="playgroundPromptRef" class="select">
                    <option value="">(none)</option>
                  </select>
                </div>
                <div class="config-group">
                  <label>Template Variables (JSON, optional)</label>
                  <textarea id="playgroundPromptInput" class="textarea" rows="3" placeholder='{"service":"checkout","env":"prod"}'></textarea>
                </div>
                <div class="config-group">
                  <label>Custom Instructions (advanced)</label>
                  <textarea id="playgroundSystemPrompt" class="textarea" rows="3" placeholder="Leave empty unless you need to override defaults"></textarea>
                </div>
              </details>
              <div class="config-group" style="margin-top:8px;">
                <label>Input Mode</label>
                <div class="toggle-group">
                  <button class="toggle-btn active" id="modeChatBtn" onclick="setInputMode('chat')">Chat</button>
                  <button class="toggle-btn" id="modeJsonBtn" onclick="setInputMode('json')">JSON Payload</button>
                </div>
              </div>
              <div id="playgroundGraphPreview" class="config-group graph-preview" style="display:none;">
                <label>Graph Topology</label>
                <canvas id="graphCanvas" width="600" height="200"></canvas>
              </div>
            </div>

            <div class="playground-chat" id="playgroundChatMode">
              <div class="chat-messages" id="chatMessages">
                <div class="chat-welcome">
                  <div class="welcome-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="48" height="48">
                      <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/>
                    </svg>
                  </div>
                  <h3>Start a conversation</h3>
                  <p>Select an agent flow above, or configure manually, then type a message.</p>
                </div>
              </div>
              <div class="chat-input-container">
                <textarea id="chatInput" class="chat-input" placeholder="Send a message..." rows="1"></textarea>
                <button id="sendMessage" class="btn btn-primary btn-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                    <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                  </svg>
                </button>
              </div>
            </div>

            <div class="playground-json" id="playgroundJsonMode" style="display:none;">
              <div class="json-editor-container">
                <label>JSON Input Payload</label>
                <textarea id="jsonPayloadInput" class="textarea json-editor" rows="12" placeholder='{"input": "your prompt here", "data": {}}'></textarea>
                <div id="jsonValidation" class="json-validation"></div>
              </div>
              <button class="btn btn-primary" id="sendJsonPayload" style="margin-top:8px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                  <path d="M5 12h14M12 5l7 7-7 7"/>
                </svg>
                Execute
              </button>
              <div id="jsonResultOutput" class="json-result" style="display:none;">
                <label>Output</label>
                <pre id="jsonResultContent" class="json-output"></pre>
                <div id="jsonResultArtifacts" class="chat-artifacts" style="display:none;"></div>
              </div>
            </div>

            <!-- History Panel (collapsible) -->
            <div class="playground-history" id="playgroundHistory" style="display:none;">
              <div class="history-header">
                <h3>Conversation History</h3>
                <button class="btn btn-ghost btn-sm" onclick="togglePlaygroundHistory()" title="Close">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                    <path d="M18 6L6 18M6 6l12 12"/>
                  </svg>
                </button>
              </div>
              <div class="history-actions">
                <button class="btn btn-sm btn-primary" onclick="startNewConversation()" title="New conversation">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                    <path d="M12 5v14M5 12h14"/>
                  </svg>
                  New
                </button>
                <button class="btn btn-sm btn-ghost" onclick="loadPlaygroundHistory()" title="Refresh">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                    <path d="M1 4v6h6M23 20v-6h-6"/>
                    <path d="M20.49 9A9 9 0 005.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 013.51 15"/>
                  </svg>
                </button>
              </div>
              <div class="history-list" id="historyList">
                <div class="history-empty">No conversations yet</div>
              </div>
            </div>
          </div>
        </section>

        <!-- Actions Tab (Genkit-style) -->
        <section id="tab-actions" class="tab">
          <div class="page-header">
            <h1>Actions</h1>
            <p class="page-subtitle">Browse, inspect, and run individual tools and flows — like Genkit's action runner</p>
            <div class="header-actions">
              <button class="btn btn-secondary" onclick="loadActions()">Refresh</button>
            </div>
          </div>

          <div class="actions-layout">
            <!-- Left: Action List -->
            <div class="actions-list-panel">
              <div class="actions-filter">
                <input id="actionsSearch" class="input" placeholder="Filter actions..." oninput="filterActions()" />
                <div class="actions-type-filter" id="actionsTypeFilter">
                  <button class="toggle-btn active" data-type="all" onclick="filterActionsByType('all')">All</button>
                  <button class="toggle-btn" data-type="flow" onclick="filterActionsByType('flow')">Flows</button>
                  <button class="toggle-btn" data-type="tool" onclick="filterActionsByType('tool')">Tools</button>
                  <button class="toggle-btn" data-type="workflow" onclick="filterActionsByType('workflow')">Workflows</button>
                </div>
              </div>
              <div class="actions-list" id="actionsList">
                <div class="empty-state"><p>Loading actions…</p></div>
              </div>
            </div>

            <!-- Right: Action Detail + Run -->
            <div class="actions-detail-panel" id="actionsDetailPanel">
              <div class="empty-state" id="actionsEmptyDetail">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="48" height="48">
                  <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                </svg>
                <h3>Select an action</h3>
                <p>Choose a tool or flow from the list to inspect its schema and run it.</p>
              </div>

              <div id="actionDetail" style="display:none;">
                <div class="action-header">
                  <span class="action-type-badge" id="actionDetailType"></span>
                  <h2 id="actionDetailName"></h2>
                  <p id="actionDetailDesc" class="page-subtitle"></p>
                </div>

                <!-- Schema Info -->
                <div class="card" style="margin-bottom:16px;">
                  <div class="card-header"><h3>Input Schema</h3></div>
                  <div class="card-body" id="actionSchemaInfo">
                    <pre id="actionSchemaRaw" class="json-output" style="max-height:200px;overflow:auto;font-size:12px;"></pre>
                  </div>
                </div>

                <!-- Auto-generated Input Form -->
                <div class="card" style="margin-bottom:16px;">
                  <div class="card-header">
                    <h3>Input</h3>
                    <div class="toggle-group" style="margin-left:auto;">
                      <button class="toggle-btn active" id="actionFormModeBtn" onclick="setActionInputMode('form')">Form</button>
                      <button class="toggle-btn" id="actionJsonModeBtn" onclick="setActionInputMode('json')">JSON</button>
                    </div>
                  </div>
                  <div class="card-body">
                    <div id="actionFormFields"></div>
                    <div id="actionJsonEditor" style="display:none;">
                      <textarea id="actionJsonInput" class="textarea json-editor" rows="8" placeholder="{}"></textarea>
                    </div>
                    <button class="btn btn-primary" onclick="runAction()" style="margin-top:12px;" id="runActionBtn" data-requires-role="operator">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                        <polygon points="5,3 19,12 5,21"/>
                      </svg>
                      Run
                    </button>
                  </div>
                </div>

                <!-- Result -->
                <div class="card" id="actionResultCard" style="display:none;">
                  <div class="card-header">
                    <h3>Result</h3>
                    <span class="status-badge" id="actionResultStatus"></span>
                    <span style="margin-left:auto;font-size:12px;color:var(--text-muted);" id="actionResultDuration"></span>
                  </div>
                  <div class="card-body">
                    <pre id="actionResultOutput" class="json-output" style="max-height:400px;overflow:auto;"></pre>
                  </div>
                </div>

                <!-- Trace / History -->
                <div class="card" id="actionTraceCard" style="display:none;margin-top:16px;">
                  <div class="card-header"><h3>Execution Trace</h3></div>
                  <div class="card-body" id="actionTraceContent"></div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Prompts Tab -->
        <section id="tab-prompts" class="tab">
          <div class="page-header">
            <h1>Prompts</h1>
            <p class="page-subtitle">Genkit-style prompt resources: version, validate, render, and persist.</p>
            <div class="header-actions">
              <button class="btn btn-secondary" id="refreshPrompts">Refresh</button>
              <button class="btn btn-primary" id="newPromptBtn" data-requires-role="operator">New Prompt</button>
            </div>
          </div>

          <div class="actions-layout">
            <div class="actions-list-panel card">
              <div class="card-header"><h3>Prompt Registry</h3></div>
              <div class="card-body" id="promptsList" style="max-height:640px;overflow:auto;">
                <div class="empty-state"><p>Loading prompts...</p></div>
              </div>
            </div>

            <div class="actions-detail-panel">
              <div class="card" style="margin-bottom:16px;">
                <div class="card-header"><h3>Prompt Editor</h3></div>
                <div class="card-body">
                  <div class="config-group">
                    <label>Name</label>
                    <input id="promptNameInput" class="input" placeholder="incident-triage" />
                  </div>
                  <div class="config-group">
                    <label>Version</label>
                    <input id="promptVersionInput" class="input" placeholder="v1" value="v1" />
                  </div>
                  <div class="config-group">
                    <label>Description</label>
                    <input id="promptDescriptionInput" class="input" placeholder="Describe behavior and constraints" />
                  </div>
                  <div class="config-group">
                    <label>System Template</label>
                    <textarea id="promptSystemInput" class="textarea json-editor" rows="10" placeholder="You are an assistant for {{service}} in {{env}}"></textarea>
                  </div>
                  <div class="config-group">
                    <label>Render Variables (JSON)</label>
                    <textarea id="promptVarsInput" class="textarea json-editor" rows="4" placeholder='{"service":"checkout","env":"prod"}'></textarea>
                  </div>
                  <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;">
                    <button class="btn btn-secondary" id="validatePromptBtn">Validate</button>
                    <button class="btn btn-secondary" id="renderPromptBtn">Render</button>
                    <button class="btn btn-primary" id="savePromptBtn" data-requires-role="operator">Save</button>
                    <button class="btn btn-danger" id="deletePromptBtn" data-requires-role="operator">Delete</button>
                  </div>
                </div>
              </div>

              <div class="card">
                <div class="card-header"><h3>Render Output</h3></div>
                <div class="card-body">
                  <pre id="promptRenderOutput" class="json-output" style="max-height:360px;overflow:auto;">Select a prompt to inspect or render.</pre>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Workflows Tab -->
        <section id="tab-workflows" class="tab">
          <div class="page-header">
            <h1>Workflows</h1>
            <div class="header-actions">
              <button class="btn btn-primary" id="toggleWorkflowCreate" data-requires-role="operator">+ Create</button>
              <button class="btn btn-secondary" id="refreshWorkflows">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                  <path d="M23 4v6h-6M1 20v-6h6"/>
                  <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
                </svg>
                Refresh
              </button>
            </div>
          </div>

          <div id="workflowCreateForm" class="card" style="display:none; margin-bottom:20px;">
            <div class="card-header"><h3>Create Workflow</h3></div>
            <div class="card-body" style="padding:16px;">
              <div class="config-group">
                <label>Workflow Name</label>
                <input id="workflowCreateName" class="input" placeholder="incident-triage" />
              </div>
              <div class="config-group">
                <label>Description (optional)</label>
                <input id="workflowCreateDescription" class="input" placeholder="Route and triage incoming incidents" />
              </div>
              <div class="config-group">
                <label>Workflow Spec (JSON)</label>
                <textarea id="workflowCreateSpec" class="textarea json-editor" rows="14" placeholder='{"start":"prepare","nodes":[],"edges":[]}'></textarea>
                <small style="color:var(--text-muted);font-size:11px;">Supported node kinds: noop, set, template, agent, output, router_json_key</small>
              </div>
              <div style="display:flex;gap:8px;margin-top:12px;">
                <button class="btn btn-primary" id="createWorkflowBtn" data-requires-role="operator">Create</button>
                <button class="btn btn-secondary" id="cancelWorkflowCreate">Cancel</button>
              </div>
            </div>
          </div>

          <div class="workflows-grid" id="workflowsGrid">
            <div class="empty-state">
              <p>Loading workflows...</p>
            </div>
          </div>
          <div class="card topology-card">
            <div class="card-header">
              <h3>Graph Topology</h3>
            </div>
            <div class="topology-controls">
              <label>Workflow
                <select id="graphWorkflowSelect" class="select"></select>
              </label>
              <label>Run Overlay
                <select id="graphRunSelect" class="select"></select>
              </label>
              <button class="btn btn-secondary btn-sm" id="refreshTopology">Refresh Topology</button>
              <div class="zoom-controls">
                <button class="btn btn-ghost btn-sm" id="zoomOut" title="Zoom out">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM8 11h6"/></svg>
                </button>
                <span class="zoom-level" id="zoomLevel">100%</span>
                <button class="btn btn-ghost btn-sm" id="zoomIn" title="Zoom in">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM11 8v6M8 11h6"/></svg>
                </button>
                <button class="btn btn-ghost btn-sm" id="zoomReset" title="Reset zoom">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/></svg>
                </button>
              </div>
            </div>
            <div class="topology-canvas-wrap" id="topologyCanvasWrap">
              <svg id="workflowGraphSvg" viewBox="0 0 1200 420"></svg>
            </div>
          </div>
        </section>

        <!-- Tools Tab -->
        <section id="tab-tools" class="tab">
          <div class="page-header">
            <h1>Tools Catalog</h1>
            <div class="header-actions">
              <button class="btn btn-secondary" id="refreshTools">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                  <path d="M23 4v6h-6M1 20v-6h6"/>
                  <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
                </svg>
                Refresh
              </button>
            </div>
          </div>

          <div class="tool-intel-grid">
            <div class="card">
              <div class="card-header">
                <h3>Capability Heatmap</h3>
              </div>
              <div class="tool-heatmap" id="toolHeatmap">
                <div class="empty-state">
                  <p>Collecting tool intelligence...</p>
                </div>
              </div>
            </div>
            <div class="card">
              <div class="card-header">
                <h3>Failure Hotspots</h3>
              </div>
              <div class="tool-hotspots" id="toolHotspots">
                <div class="empty-state">
                  <p>No hotspots yet</p>
                </div>
              </div>
            </div>
          </div>

          <div class="tools-tabs">
            <button class="tools-tab active" data-tools-tab="builtin">Built-in Tools</button>
            <button class="tools-tab" data-tools-tab="bundles">Bundles</button>
            <button class="tools-tab" data-tools-tab="integrations">Integrations</button>
          </div>

          <div id="tools-builtin" class="tools-panel active">
            <div class="tools-grid" id="toolsGrid">
              <div class="empty-state">
                <p>Loading tools...</p>
              </div>
            </div>
          </div>

          <div id="tools-bundles" class="tools-panel">
            <div class="bundles-grid" id="bundlesGrid">
              <div class="empty-state">
                <p>Loading bundles...</p>
              </div>
            </div>
          </div>

          <div id="tools-integrations" class="tools-panel">
            <div class="integrations-grid" id="integrationsGrid">
              <div class="empty-state">
                <p>Loading integrations...</p>
              </div>
            </div>
          </div>
        </section>

        <!-- Runtime Tab -->
        <section id="tab-runtime" class="tab">
          <div class="page-header">
            <h1>Distributed Runtime</h1>
            <div class="header-actions">
              <button class="btn btn-secondary" id="refreshRuntime">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                  <path d="M23 4v6h-6M1 20v-6h6"/>
                  <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
                </svg>
                Refresh
              </button>
            </div>
          </div>

          <div class="runtime-grid">
            <div class="card">
              <div class="card-header">
                <h3>Queue Status</h3>
              </div>
              <div class="queue-stats" id="queueStats">
                <div class="stat-row">
                  <span class="stat-label">Stream Length</span>
                  <span class="stat-value" id="queue-stream">-</span>
                </div>
                <div class="stat-row">
                  <span class="stat-label">Pending</span>
                  <span class="stat-value" id="queue-pending">-</span>
                </div>
                <div class="stat-row">
                  <span class="stat-label">DLQ Length</span>
                  <span class="stat-value" id="queue-dlq">-</span>
                </div>
                <div class="stat-row">
                  <span class="stat-label">Runtime Status</span>
                  <span class="stat-value" id="runtime-status">-</span>
                </div>
                <div class="stat-row">
                  <span class="stat-label">Runtime Errors</span>
                  <span class="stat-value" id="runtime-errors">-</span>
                </div>
              </div>
              <div class="queue-lag-panel">
                <div class="queue-wave">
                  <div class="queue-wave-fill" id="queueWaveFill"></div>
                </div>
                <div class="queue-lag-meta">
                  <span id="queueLagLabel">Lag nominal</span>
                  <span id="queueHealthLabel">Healthy</span>
                </div>
              </div>
            </div>

            <div class="card">
              <div class="card-header">
                <h3>Workers</h3>
              </div>
              <div class="worker-fleet" id="workerFleet">
                <div class="empty-state">
                  <p>No worker heartbeat</p>
                </div>
              </div>
              <div class="workers-list" id="workersList">
                <div class="empty-state">
                  <p>No workers connected</p>
                </div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <h3>Queue Events</h3>
              <button class="btn btn-secondary btn-sm" id="refreshQueueEvents">Refresh</button>
            </div>
            <div class="queue-events" id="queueEventsList">
              <div class="empty-state"><p>No queue events available.</p></div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <h3>Dead Letter Queue</h3>
            </div>
            <div class="dlq-list" id="dlqList">
              <div class="empty-state">
                <p>No failed tasks</p>
              </div>
            </div>
          </div>
        </section>

        <!-- Audit Tab -->
        <section id="tab-audit" class="tab">
          <div class="page-header">
            <h1>Audit Trail</h1>
            <div class="header-actions">
              <button class="btn btn-secondary" id="refreshAudit">Refresh</button>
            </div>
          </div>
          <div class="card">
            <div class="card-header">
              <h3>Mutation Log</h3>
            </div>
            <div class="audit-log" id="auditLogList">
              <div class="empty-state"><p>Loading audit events...</p></div>
            </div>
          </div>
        </section>

        <!-- Scheduler Tab -->
        <section id="tab-scheduler" class="tab">
          <div class="page-header">
            <h1>Scheduler</h1>
            <p class="page-subtitle">Manage recurring agent tasks</p>
            <div class="header-actions">
              <button class="btn btn-secondary" id="refreshCronJobs" onclick="loadCronJobs()">Refresh</button>
              <button class="btn btn-secondary" id="openCronAction" data-requires-role="operator">Use Actions</button>
              <button class="btn btn-primary" id="showAddCronJob" onclick="toggleCronForm()" data-requires-role="operator">+ Add Job</button>
            </div>
          </div>

          <div id="cronJobForm" class="card" style="display:none; margin-bottom:20px;">
            <div class="card-header"><h3>New Scheduled Job</h3></div>
            <div class="card-body" style="padding:16px;">
              <div class="config-group">
                <label>Job Name</label>
                <input id="cronJobName" class="input" placeholder="my-daily-report" />
              </div>
              <div class="config-group">
                <label>Cron Expression</label>
                <input id="cronJobExpr" class="input" placeholder="0 9 * * *" />
                <small style="color:var(--text-muted);font-size:11px;">Format: min hour day month weekday (e.g., "0 9 * * *" = daily at 9am)</small>
              </div>
              <div class="config-group">
                <label>Workflow</label>
                <select id="cronJobWorkflow" class="select">
                  <option value="">None (direct agent)</option>
                  <option value="basic">basic</option>
                </select>
              </div>
              <div class="config-group">
                <label>Input Prompt</label>
                <textarea id="cronJobInput" class="textarea" rows="3" placeholder="Agent input prompt..."></textarea>
              </div>
              <div class="config-group">
                <label>System Prompt (optional)</label>
                <textarea id="cronJobSystemPrompt" class="textarea" rows="2" placeholder="Optional system prompt override..."></textarea>
              </div>
              <div style="display:flex;gap:8px;margin-top:12px;">
                <button class="btn btn-primary" onclick="createCronJob()" id="createCronJobBtn" data-requires-role="operator">Create</button>
                <button class="btn btn-secondary" onclick="toggleCronForm()">Cancel</button>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-header"><h3>Scheduled Jobs</h3></div>
            <div id="cronJobList" class="card-body">
              <div class="empty-state"><p>No scheduled jobs yet</p></div>
            </div>
          </div>
        </section>

        <!-- Skills Tab -->
        <section id="tab-skills" class="tab">
          <div class="page-header">
            <h1>Skills</h1>
            <p class="page-subtitle">Browse and manage agent skills (Agent Skills open standard)</p>
            <div class="header-actions">
              <button class="btn btn-secondary" onclick="loadSkills()">Refresh</button>
              <button class="btn btn-primary" id="showInstallSkill" onclick="toggleSkillInstallForm()" data-requires-role="operator">+ Install from GitHub</button>
            </div>
          </div>

          <div id="skillInstallForm" class="card" style="display:none; margin-bottom:20px;">
            <div class="card-header"><h3>Install Skill from GitHub</h3></div>
            <div class="card-body" style="padding:16px;">
              <div class="config-group">
                <label>Repository URL or ref</label>
                <input id="skillRepoUrl" class="input" placeholder="openai/skills or https://github.com/openai/skills" />
                <small style="color:var(--text-muted);font-size:11px;">Supports owner/repo format or full GitHub URLs</small>
              </div>
              <div style="display:flex;gap:8px;margin-top:12px;">
                <button class="btn btn-primary" id="installSkillBtn" onclick="installSkillFromGitHub()" data-requires-role="operator">Install</button>
                <button class="btn btn-secondary" onclick="toggleSkillInstallForm()">Cancel</button>
              </div>
            </div>
          </div>

          <div id="skillsList" class="card">
            <div class="card-header"><h3>Installed Skills</h3></div>
            <div id="skillsListBody" class="card-body">
              <div class="empty-state"><p>Loading skills...</p></div>
            </div>
          </div>

          <div id="skillDetail" class="card" style="display:none; margin-top:20px;">
            <div class="card-header"><h3 id="skillDetailName">Skill Details</h3></div>
            <div id="skillDetailBody" class="card-body" style="padding:16px;">
            </div>
          </div>
        </section>

        <!-- Settings Tab -->
        <section id="tab-settings" class="tab">
          <div class="page-header">
            <h1>Settings</h1>
            <p class="page-subtitle">Console configuration and API keys</p>
          </div>

          <div class="settings-grid">
            <div class="card">
              <div class="card-header">
                <h3>API Configuration</h3>
              </div>
              <div class="form-group">
                <label>API Key</label>
                <div class="input-with-button">
                  <input type="password" id="apiKeyInput" class="input" placeholder="Enter your API key...">
                  <button class="btn btn-secondary" id="saveApiKey">Save</button>
                </div>
                <small class="help-text">Used for authenticating with the DevUI API</small>
              </div>

              <div class="form-group" style="margin-top:16px;">
                <label>LLM Provider</label>
                <select id="providerSelect" class="select">
                  <option value="gemini">gemini</option>
                  <option value="openai">openai</option>
                  <option value="anthropic">anthropic</option>
                  <option value="azureopenai">azureopenai</option>
                  <option value="ollama">ollama</option>
                </select>
                <small class="help-text">Sets <code>AGENT_PROVIDER</code> for playground runs</small>
              </div>

              <div class="form-group" style="margin-top:12px;">
                <label>Provider API Key</label>
                <div class="input-with-button">
                  <input type="password" id="providerApiKeyInput" class="input" placeholder="Enter provider API key...">
                  <button class="btn btn-secondary" id="saveProviderSettings" data-requires-role="operator">Save</button>
                </div>
                <small class="help-text" id="providerKeyHelp">Persisted in <code>.ai-agent/provider_env.json</code></small>
              </div>

              <div class="form-group" style="margin-top:12px;">
                <label>Provider Model</label>
                <div class="input-with-button">
                  <select id="providerModelSelect" class="select">
                    <option value="">(auto/default)</option>
                  </select>
                  <button class="btn btn-secondary" id="refreshProviderModels" data-requires-role="operator">Refresh</button>
                </div>
                <small class="help-text" id="providerModelHelp">Sets provider-specific model env (for example <code>GEMINI_MODEL</code>)</small>
              </div>
            </div>

            <div class="card" id="authKeysCard" data-requires-role="admin">
              <div class="card-header">
                <h3>Auth Keys</h3>
                <button class="btn btn-secondary btn-sm" id="refreshKeys">Refresh</button>
              </div>
              <div class="keys-list" id="authKeysList">
                <div class="empty-state">
                  <p>Admin role required to view keys</p>
                </div>
              </div>
            </div>
          </div>
        </section>
      </main>
    </div>

    <script src="/app.js"></script>
  </body>
</html>
